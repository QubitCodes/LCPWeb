# name: Auto Deploy Next.js

# on:
#   push:
#     branches:
#       - main # Deploy when pushing to main branch

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout source code
#         uses: actions/checkout@v3

#       - name: Connect to Server and Deploy
#         uses: appleboy/ssh-action@v0.1.10
#         with:
#           host: ${{ secrets.SERVER_HOST }}
#           username: ${{ secrets.SERVER_USER }}
#           key: ${{ secrets.SERVER_SSH_KEY }}
#           script: |
#             cd /home/ubuntu/Projects/CyberFort-WebAdmin || { echo "âŒ Folder not found"; exit 1; }

#             echo "ğŸ“¥ Pulling latest code..."
#             git pull origin main || { echo "âŒ Git pull failed"; exit 1; }

#             echo "ğŸ“¦ Installing dependencies..."
#             npm install --legacy-peer-deps || { echo "âŒ NPM install failed"; exit 1; }

#             echo "ğŸ”¨ Building Next.js..."
#             npm run build || { echo "âŒ Build failed"; exit 1; }

#             echo "ğŸ”„ Restarting PM2..."
#             pm2 restart next-app || { echo "âŒ PM2 restart failed"; exit 1; }

#             echo "âœ… Deployment complete!"
# -----------------------------------------------------------

- name: Connect to Server and Deploy
  uses: appleboy/ssh-action@v0.1.10
  with:
    host: ${{ secrets.SERVER_HOST }}
    username: ${{ secrets.SERVER_USER }}
    key: ${{ secrets.SERVER_SSH_KEY }}
    script: |
      set -e

      REPO_DIR="/home/ubuntu/Projects/CyberFort-WebAdmin"
      REPO_URL="git@github.com:rohithmp2000/CyberFort-WebAdmin.git"
      BRANCH="main"

      echo "â¡ï¸ Ensure Projects folder exists"
      mkdir -p /home/ubuntu/Projects
      # If repo folder exists, pull latest; otherwise clone
      if [ -d "$REPO_DIR/.git" ]; then
        echo "ğŸ“¥ Pulling latest code from $BRANCH..."
        cd "$REPO_DIR"
        git fetch origin $BRANCH
        git reset --hard origin/$BRANCH
      else
        echo "ğŸ“‚ Repo folder not found â€” cloning..."
        git clone --depth=1 --branch $BRANCH "$REPO_URL" "$REPO_DIR"
        cd "$REPO_DIR"
      fi

      echo "ğŸ“¦ Installing dependencies..."
      # Use nvm if needed; or ensure system node version is OK on the server
      npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      echo "ğŸ”¨ Building Next.js..."
      npm run build

      echo "ğŸ”„ Restarting PM2..."
      pm2 restart next-app || pm2 start npm --name next-app -- start

      echo "âœ… Deployment complete!"
